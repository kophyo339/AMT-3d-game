import { S as Script, m as math, K as KEY_DOWN, a as KEY_S, b as KEY_UP, c as KEY_W, d as KEY_RIGHT, e as KEY_D, f as KEY_LEFT, g as KEY_A, X as XRHAND_LEFT, h as XRHAND_RIGHT, E as Entity, p as platform, V as Vec3, G as GraphNode, M as MeshInstance, i as StandardMaterial, B as BLEND_NORMAL, j as createCapsule, k as createSphere, l as createCylinder, n as createCone, o as createBox, q as Model, r as Mat4, Q as Quat, s as XRTYPE_VR, t as XRSPACE_BOUNDEDFLOOR, u as XRSPACE_LOCAL, v as XRSPACE_LOCALFLOOR, w as XRSPACE_UNBOUNDED, x as XRSPACE_VIEWER } from './index.mjs';

function _define_property$a(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class Vehicle extends Script{get speed(){return this.vehicle?this.vehicle.getCurrentSpeedKmHour():0}postInitialize(){const body=this.entity.rigidbody.body;const dynamicsWorld=this.app.systems.rigidbody.dynamicsWorld;const tuning=new Ammo.btVehicleTuning;const rayCaster=new Ammo.btDefaultVehicleRaycaster(dynamicsWorld);const vehicle=new Ammo.btRaycastVehicle(tuning,body,rayCaster);vehicle.setCoordinateSystem(0,1,2);const DISABLE_DEACTIVATION=4;body.setActivationState(DISABLE_DEACTIVATION);const axle=new Ammo.btVector3(-1,0,0);const direction=new Ammo.btVector3(0,-1,0);const connection=new Ammo.btVector3(0,0,0);const tmpArr=[];this.wheels.forEach(wheelEntity=>{const ws=wheelEntity.script.vehicleWheel;wheelEntity.getLocalPosition().toArray(tmpArr);connection.setValue(...tmpArr);const info=vehicle.addWheel(connection,direction,axle,ws.suspensionRestLength,ws.radius,tuning,ws.isFront);info.set_m_suspensionStiffness(ws.suspensionStiffness);info.set_m_wheelsDampingRelaxation(ws.suspensionDamping);info.set_m_wheelsDampingCompression(ws.suspensionCompression);info.set_m_frictionSlip(ws.frictionSlip);info.set_m_rollInfluence(ws.rollInfluence);});Ammo.destroy(axle);Ammo.destroy(direction);Ammo.destroy(connection);dynamicsWorld.addAction(vehicle);this.vehicle=vehicle;this.engineForce=0;this.brakingForce=0;this.steering=0;this.on("enable",()=>dynamicsWorld.addAction(vehicle));this.on("disable",()=>dynamicsWorld.removeAction(vehicle));this.on("destroy",()=>{dynamicsWorld.removeAction(vehicle);Ammo.destroy(rayCaster);Ammo.destroy(vehicle);});this.on("vehicle:controls",(steer,throttle)=>{this.steering=math.lerp(this.steering,steer*this.maxSteering,.3);if(throttle>0){this.brakingForce=0;this.engineForce=this.maxEngineForce;}else if(throttle<0){this.brakingForce=0;this.engineForce=-this.maxEngineForce;}else {this.brakingForce=this.maxBrakingForce;this.engineForce=0;}});}update(){const v=this.vehicle;v.setSteeringValue(this.steering,0);v.setSteeringValue(this.steering,1);v.applyEngineForce(this.engineForce,2);v.setBrake(this.brakingForce,2);v.applyEngineForce(this.engineForce,3);v.setBrake(this.brakingForce,3);for(let i=0;i<v.getNumWheels();i++){v.updateWheelTransform(i,true);const t=v.getWheelTransformWS(i);const p=t.getOrigin();const q=t.getRotation();const wheel=this.wheels[i];wheel.setPosition(p.x(),p.y(),p.z());wheel.setRotation(q.x(),q.y(),q.z(),q.w());}}constructor(...args){super(...args);_define_property$a(this,"wheels",void 0);_define_property$a(this,"maxEngineForce",2e3);_define_property$a(this,"maxBrakingForce",100);_define_property$a(this,"maxSteering",.3);}}class VehicleWheel extends Script{initialize(){const createDebugWheel=(radius,width)=>{const e=new Entity;e.addComponent("model",{type:"cylinder",castShadows:true});e.setLocalEulerAngles(0,0,90);e.setLocalScale(radius*2,width,radius*2);return e};if(this.debugRender){this.debugWheel=createDebugWheel(this.radius,this.width);this.entity.addChild(this.debugWheel);}this.on("attr:debugRender",value=>{if(value){this.debugWheel=createDebugWheel(this.radius,this.width);this.entity.addChild(this.debugWheel);}else if(this.debugWheel){this.debugWheel.destroy();this.debugWheel=null;}});}constructor(...args){super(...args);_define_property$a(this,"isFront",true);_define_property$a(this,"radius",.4);_define_property$a(this,"width",.4);_define_property$a(this,"suspensionStiffness",10);_define_property$a(this,"suspensionDamping",2.3);_define_property$a(this,"suspensionCompression",4.4);_define_property$a(this,"suspensionRestLength",.2);_define_property$a(this,"rollInfluence",.2);_define_property$a(this,"frictionSlip",1e3);_define_property$a(this,"debugRender",false);}}class VehicleControls extends Script{initialize(){this.leftButtonPressed=this.rightButtonPressed=false;this.upButtonPressed=this.downButtonPressed=false;this.leftKeyPressed=this.rightKeyPressed=false;this.upKeyPressed=this.downKeyPressed=false;const setupButton=(btn,stateProp)=>{if(!btn)return;btn.enabled=platform.mobile;btn.button.on("pressedstart",()=>this[stateProp]=true);btn.button.on("pressedend",()=>this[stateProp]=false);};setupButton(this.leftButton,"leftButtonPressed");setupButton(this.rightButton,"rightButtonPressed");setupButton(this.forwardButton,"upButtonPressed");setupButton(this.reverseButton,"downButtonPressed");this.app.keyboard.on("keydown",e=>{switch(e.key){case KEY_A:case KEY_LEFT:this.leftKeyPressed=true;break;case KEY_D:case KEY_RIGHT:this.rightKeyPressed=true;break;case KEY_W:case KEY_UP:this.upKeyPressed=true;break;case KEY_S:case KEY_DOWN:this.downKeyPressed=true;break}});this.app.keyboard.on("keyup",e=>{switch(e.key){case KEY_A:case KEY_LEFT:this.leftKeyPressed=false;break;case KEY_D:case KEY_RIGHT:this.rightKeyPressed=false;break;case KEY_W:case KEY_UP:this.upKeyPressed=false;break;case KEY_S:case KEY_DOWN:this.downKeyPressed=false;break}});}update(){const vehicle=this.targetVehicle||this.entity;if(!vehicle)return;let steering=0;let throttle=0;if(this.leftButtonPressed||this.leftKeyPressed)steering+=1;if(this.rightButtonPressed||this.rightKeyPressed)steering-=1;if(this.upButtonPressed||this.upKeyPressed)throttle+=1;if(this.downButtonPressed||this.downKeyPressed)throttle-=1;this.app.xr.input.inputSources.forEach(input=>{if(input.handedness===XRHAND_LEFT){steering=-input.gamepad.axes[2];throttle-=input.gamepad.buttons[0].value;}if(input.handedness===XRHAND_RIGHT){throttle+=input.gamepad.buttons[0].value;}});vehicle.script.vehicle.fire("vehicle:controls",steering,throttle);}constructor(...args){super(...args);_define_property$a(this,"targetVehicle",void 0);_define_property$a(this,"leftButton",void 0);_define_property$a(this,"rightButton",void 0);_define_property$a(this,"forwardButton",void 0);_define_property$a(this,"reverseButton",void 0);}}

var vehicle = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Vehicle: Vehicle,
    VehicleControls: VehicleControls,
    VehicleWheel: VehicleWheel
});

function _define_property$9(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class ActionPhysicsReset extends Script{postInitialize(){const app=this.app;const entity=this.entity;const initialPos=entity.getPosition().clone();const initialRot=entity.getRotation().clone();const reset=()=>{const rigidbody=entity.rigidbody;if(rigidbody&&rigidbody.type==="dynamic"){rigidbody.teleport(initialPos,initialRot);rigidbody.linearVelocity=Vec3.ZERO;rigidbody.angularVelocity=Vec3.ZERO;}};if(this.event&&this.event.length>0){app.on(this.event,reset);}this.on("attr:event",(value,prev)=>{if(prev&&prev.length>0){app.off(prev,reset);}if(value&&value.length>0){app.on(value,reset);}});this.on("destroy",()=>{if(this.event&&this.event.length>0){app.off(this.event,reset);}});}constructor(...args){super(...args);_define_property$9(this,"event",void 0);}}

var actionPhysicsReset = /*#__PURE__*/Object.freeze({
    __proto__: null,
    ActionPhysicsReset: ActionPhysicsReset
});

function _define_property$8(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class DebugPhysics extends Script{initialize(){this.debugRoot=new Entity("Physics Debug Root");this.app.root.addChild(this.debugRoot);this.on("attr:castShadows",value=>{this.debugRoot.children.forEach(child=>{child.model.castShadows=value;});});this.on("attr:opacity",value=>{this.debugRoot.children.forEach(child=>{child.model.meshInstances.forEach(mi=>{mi.material.opacity=value;mi.material.update();});});});this.on("enable",()=>{this.debugRoot=new Entity("Physics Debug Root");this.app.root.addChild(this.debugRoot);});this.on("disable",()=>{const collisions=this.app.root.findComponents("collision");collisions.forEach(col=>{if(col._debugShape){delete col._debugShape;}});this.debugRoot.destroy();});}createModel(mesh,material){const node=new GraphNode;const meshInstance=new MeshInstance(node,mesh,material);const model=new Model;model.graph=node;model.meshInstances=[meshInstance];return model}postUpdate(dt){this.debugRoot.children.forEach(child=>{child.updated=false;});if(!this.drawShapes)return;const collisions=this.app.root.findComponents("collision");collisions.forEach(col=>{if(!col.enabled||!col.entity.enabled)return;let recreate=false;if(col._debugShape){const ds=col._debugShape;if(ds._collisionType!==col.type){recreate=true;}else {switch(col.type){case"box":if(!ds._halfExtents.equals(col.halfExtents))recreate=true;break;case"cone":case"cylinder":case"capsule":if(ds._height!==col.height||ds._radius!==col.radius)recreate=true;break;case"sphere":if(ds._radius!==col.radius)recreate=true;break}}}if(recreate&&col._debugShape){col._debugShape.destroy();delete col._debugShape;}if(!col._debugShape){const material=new StandardMaterial;material.diffuse.set(Math.random(),Math.random(),Math.random());material.opacity=this.opacity;material.blendType=BLEND_NORMAL;material.update();const debugShape=new Entity;let mesh;switch(col.type){case"box":mesh=createBox(this.app.graphicsDevice,{halfExtents:col.halfExtents});debugShape._halfExtents=col.halfExtents.clone();break;case"cone":mesh=createCone(this.app.graphicsDevice,{height:col.height,radius:col.radius});debugShape._height=col.height;debugShape._radius=col.radius;break;case"cylinder":mesh=createCylinder(this.app.graphicsDevice,{height:col.height,radius:col.radius});debugShape._height=col.height;debugShape._radius=col.radius;break;case"sphere":mesh=createSphere(this.app.graphicsDevice,{radius:col.radius});debugShape._radius=col.radius;break;case"capsule":mesh=createCapsule(this.app.graphicsDevice,{height:col.height,radius:col.radius});debugShape._height=col.height;debugShape._radius=col.radius;break}if(mesh){debugShape.addComponent("model",{castShadows:this.castShadows,type:"asset"});debugShape.model.model=this.createModel(mesh,material);}this.debugRoot.addChild(debugShape);debugShape._collision=col;debugShape._collisionType=col.type;col._debugShape=debugShape;}const shape=col._debugShape;if(col.entity.rigidbody&&col.entity.rigidbody.data.body){const body=col.entity.rigidbody.data.body;const t=body.getWorldTransform();const p=t.getOrigin();const q=t.getRotation();shape.setPosition(p.x(),p.y(),p.z());shape.setRotation(q.x(),q.y(),q.z(),q.w());}else {shape.setPosition(col.entity.getPosition());shape.setRotation(col.entity.getRotation());}shape.updated=true;});this.debugRoot.children.forEach(child=>{if(!child.updated){if(child._collision)delete child._collision._debugShape;delete child._collision;child.destroy();}});}constructor(...args){super(...args);_define_property$8(this,"drawShapes",false);_define_property$8(this,"opacity",.5);_define_property$8(this,"castShadows",true);}}

var debugPhysics = /*#__PURE__*/Object.freeze({
    __proto__: null,
    DebugPhysics: DebugPhysics
});

class Exhaust extends Script{update(dt){const car=this.app.root.findByName("Car Physics");const vehicleScript=car?.script?.vehicle;if(vehicleScript){const throttle=vehicleScript.engineForce;if(throttle>0){this.entity.particlesystem.play();}else {this.entity.particlesystem.stop();}}}}

var exhaust = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Exhaust: Exhaust
});

function _define_property$7(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class UiSpeed extends Script{initialize(){this._intervalHandle=setInterval(()=>{if(this.car?.script?.vehicle){const speed=this.car.script.vehicle.speed;const absSpeed=Math.abs(speed);let text=`Speed: ${Math.round(absSpeed)}km/h`;if(speed<0){text+=" (R)";}this.entity.element.text=text;}},100);this.on("destroy",()=>{clearInterval(this._intervalHandle);});}constructor(...args){super(...args);_define_property$7(this,"car",void 0);}}

var uiSpeed = /*#__PURE__*/Object.freeze({
    __proto__: null,
    UiSpeed: UiSpeed
});

function _define_property$6(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class FollowCamera extends Script{initialize(){this.targetPos=new Vec3;this.matrix=new Mat4;this.quat=new Quat;this.vec=new Vec3;if(this.target){this.updateTargetPosition();this.currentPos=this.targetPos.clone();}else {this.currentPos=this.entity.getPosition().clone();}}updateTargetPosition(){const forward=this.target.forward;this.vec.set(-forward.x,0,-forward.z).normalize();const angle=Math.atan2(this.vec.x,this.vec.z)*180/Math.PI;this.quat.setFromEulerAngles(0,angle,0);this.matrix.setTRS(this.target.getPosition(),this.quat,Vec3.ONE);this.matrix.transformPoint(this.cameraOffset,this.targetPos);}postUpdate(dt){if(this.target){this.updateTargetPosition();this.currentPos.lerp(this.currentPos,this.targetPos,1-Math.pow(1-this.lerpAmount,dt));this.entity.setPosition(this.currentPos);this.entity.lookAt(this.target.getPosition());}}constructor(...args){super(...args);_define_property$6(this,"target",void 0);_define_property$6(this,"cameraOffset",new Vec3(0,5,-10));_define_property$6(this,"lerpAmount",.1);}}

var followCamera = /*#__PURE__*/Object.freeze({
    __proto__: null,
    FollowCamera: FollowCamera
});

function _define_property$5(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class VehicleGraphics extends Script{initialize(){this.wheels=this.wheelNames.map(name=>this.entity.findByName(name));}postUpdate(dt){if(!this.physicsVehicle||!this.physicsVehicle.script?.vehicle)return;this.entity.setPosition(this.physicsVehicle.getPosition());this.entity.setRotation(this.physicsVehicle.getRotation());const physicalWheels=this.physicsVehicle.script.vehicle.wheels;for(let i=0;i<this.wheels.length;i++){const graphicalWheel=this.wheels[i];const physicalWheel=physicalWheels[i];if(graphicalWheel&&physicalWheel){graphicalWheel.setPosition(physicalWheel.getPosition());graphicalWheel.setRotation(physicalWheel.getRotation());graphicalWheel.rotateLocal(0,180,0);}}}constructor(...args){super(...args);_define_property$5(this,"physicsVehicle",void 0);_define_property$5(this,"wheelNames",[]);_define_property$5(this,"wheelOffsets",[]);}}

var vehicleGraphics = /*#__PURE__*/Object.freeze({
    __proto__: null,
    VehicleGraphics: VehicleGraphics
});

function _define_property$4(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}const SpaceEnum={"Bounded Floor":0,"Local":1,"Local Floor":2,"Unbounded":3,"Viewer":4};class ActionVr extends Script{initialize(){if(this.startEvent&&this.startEvent.length>0){this.app.on(this.startEvent,this.startVr,this);}if(this.endEvent&&this.endEvent.length>0){this.app.on(this.endEvent,this.endVr,this);}this.on("attr:startEvent",(value,prev)=>{if(prev&&prev.length>0){this.app.off(prev,this.startVr,this);}if(value&&value.length>0){this.app.on(value,this.startVr,this);}});this.on("attr:endEvent",(value,prev)=>{if(prev&&prev.length>0){this.app.off(prev,this.endVr,this);}if(value&&value.length>0){this.app.on(value,this.endVr,this);}});this.on("destroy",()=>{if(this.startEvent&&this.startEvent.length>0){this.app.off(this.startEvent,this.startVr,this);}if(this.endEvent&&this.endEvent.length>0){this.app.off(this.endEvent,this.endVr,this);}});}startVr(){const spaces=[XRSPACE_BOUNDEDFLOOR,XRSPACE_LOCAL,XRSPACE_LOCALFLOOR,XRSPACE_UNBOUNDED,XRSPACE_VIEWER];if(!this.app.xr.supported){return}if(this.app.xr.active){return}if(!this.app.xr.isAvailable(XRTYPE_VR)){return}this.entity.camera.startXr(XRTYPE_VR,spaces[this.space]);}endVr(){this.app.xr.end();}constructor(...args){super(...args);_define_property$4(this,"startEvent",void 0);_define_property$4(this,"endEvent",void 0);_define_property$4(this,"space",SpaceEnum.Local);}}

var actionVr = /*#__PURE__*/Object.freeze({
    __proto__: null,
    ActionVr: ActionVr
});

function _define_property$3(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class EventsButton extends Script{initialize(){const fireIfValid=eventName=>{if(eventName&&eventName.length>0){this.app.fire(eventName);}};const btn=this.entity.button;btn.on("click",()=>fireIfValid(this.clickEvent));btn.on("pressedstart",()=>fireIfValid(this.pressedStartEvent));btn.on("pressedend",()=>fireIfValid(this.pressedEndEvent));btn.on("hoverstart",()=>fireIfValid(this.hoverStartEvent));btn.on("hoverend",()=>fireIfValid(this.hoverEndEvent));}constructor(...args){super(...args);_define_property$3(this,"clickEvent","");_define_property$3(this,"pressedStartEvent","");_define_property$3(this,"pressedEndEvent","");_define_property$3(this,"hoverStartEvent","");_define_property$3(this,"hoverEndEvent","");}}

var eventsButton = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EventsButton: EventsButton
});

function _define_property$2(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class ActionSetBoolean extends Script{initialize(){this.actions.forEach(action=>{this.app.on(action.event,()=>{const pathSegments=action.path.split(".");let propertyOwner=action.entity?action.entity:this.entity;for(let i=0;i<pathSegments.length-1;i++){propertyOwner=propertyOwner[pathSegments[i]];}const propertyName=pathSegments[pathSegments.length-1];propertyOwner[propertyName]=!!action.value;},this);});}constructor(...args){super(...args);_define_property$2(this,"actions",[]);}}

var actionSetProperty = /*#__PURE__*/Object.freeze({
    __proto__: null,
    ActionSetBoolean: ActionSetBoolean
});

function _define_property$1(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class EventsVr extends Script{initialize(){this.app.xr.on(`available:${XRTYPE_VR}`,this._onAvailabilityChange,this);this.app.xr.on("start",()=>{this.app.fire(this.startEvent);});this.app.xr.on("end",()=>{this.app.fire(this.endEvent);});}postInitialize(){if(this.app.xr.supported&&!this.app.xr.active){const available=this.app.xr.isAvailable(XRTYPE_VR);this.app.fire(available?this.availableEvent:this.unavailableEvent);}}_onAvailabilityChange(available){this.app.fire(available?this.availableEvent:this.unavailableEvent);}constructor(...args){super(...args);_define_property$1(this,"availableEvent","vr:available");_define_property$1(this,"unavailableEvent","vr:unavailable");_define_property$1(this,"startEvent","vr:started");_define_property$1(this,"endEvent","vr:ended");}}

var eventsVr = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EventsVr: EventsVr
});

function _define_property(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else {obj[key]=value;}return obj}class EventsKeyboard extends Script{initialize(){this._onKeyDown=this._onKeyDown.bind(this);this._onKeyUp=this._onKeyUp.bind(this);this.on("enable",this._addEventListeners,this);this.on("disable",this._removeEventListeners,this);this.on("destroy",this._removeEventListeners,this);this._addEventListeners();}_onKeyDown(e){this.keys.forEach(key=>{if(key.key===e.keyCode){if(e.repeat&&key.keyRepeatEvent?.length>0){this.app.fire(key.keyRepeatEvent,1);}else if(!e.repeat&&key.keyDownEvent?.length>0){this.app.fire(key.keyDownEvent,1);}}});}_onKeyUp(e){this.keys.forEach(key=>{if(key.key===e.keyCode&&key.keyUpEvent?.length>0){this.app.fire(key.keyUpEvent,0);}});}_addEventListeners(){window.addEventListener("keydown",this._onKeyDown,true);window.addEventListener("keyup",this._onKeyUp,true);}_removeEventListeners(){window.removeEventListener("keydown",this._onKeyDown,true);window.removeEventListener("keyup",this._onKeyUp,true);}constructor(...args){super(...args);_define_property(this,"keys",[]);}}

var eventsKeyboard = /*#__PURE__*/Object.freeze({
    __proto__: null,
    EventsKeyboard: EventsKeyboard
});

export { actionPhysicsReset as a, vehicleGraphics as b, actionVr as c, debugPhysics as d, exhaust as e, followCamera as f, eventsButton as g, actionSetProperty as h, eventsVr as i, eventsKeyboard as j, uiSpeed as u, vehicle as v };
